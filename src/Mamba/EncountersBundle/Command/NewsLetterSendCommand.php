<?php
namespace Mamba\EncountersBundle\Command;

use Mamba\EncountersBundle\Script;
use Mamba\EncountersBundle\Helpers\SearchPreferences;

/**
 * NewsLetterSendCommand
 *
 * @package EncountersBundle
 */
class NewsLetterSendCommand extends Script {

    const

        /**
         * Описание скрипта
         *
         * @var str
         */
        SCRIPT_DESCRIPTION = "Newsletter sender",

        /**
         * Имя скрипта
         *
         * @var str
         */
        SCRIPT_NAME = "cron:newsletter:send",

        /**
         * Сообщения от менеджера приложений
         *
         * @var str
         */
        FIRST_NEWSLETTER_MESSAGE = "Уважаемые друзья! Мы хотим сделать «Выбиратор» еще удобнее и полезнее, поэтому мы внимательно изучаем ваши отзывы и комментарии. Сегодня мы выкладываем соответствующие изменения: повышена стабильность работы приложения; оптимизирован алгоритм подбора людей — теперь приложение будет еще точнее подбирать партнеров по вашим интересам; улучшены некоторые части интерфейса.",
        SECOND_NEWSLETTER_MESSAGE = "В качестве благодарности за использование приложения мы зарядили вам батарейку до 100%! Спасибо, что вы с нами!"
    ;

    /**
     * Processor
     *
     * @return null
     */
    protected function process() {
        $Mamba = $this->getMamba();
        $Redis = $this->getRedis();

        $blackList = array(
            369303289,
            369303289,
            752234598,
            752234598,
            745471954,
            745471954,
            755416972,
            755416972,
            442609994,
            442609994,
            752826836,
            752826836,
            745383746,
            745383746,
            608846746,
            608846746,
            734870839,
            734870839,
            763443996,
            763443996,
            694775079,
            694775079,
            310106078,
            310106078,
            280422911,
            280422911,
            7422385,
            7422385,
            466411922,
            466411922,
            744037721,
            744037721,
            317038724,
            317038724,
            590234760,
            590234760,
            652438144,
            652438144,
            743083464,
            743083464,
            312285972,
            312285972,
            705268373,
            705268373,
            589476130,
            589476130,
            638804680,
            638804680,
            763097723,
            763097723,
            748702566,
            748702566,
            758853452,
            758853452,
            519307769,
            519307769,
            681619584,
            681619584,
            667119777,
            667119777,
            537639498,
            537639498,
            697875817,
            697875817,
            752699896,
            752699896,
            692520104,
            692520104,
            700296303,
            700296303,
            607843030,
            607843030,
            386710034,
            386710034,
            701612880,
            701612880,
            751911334,
            751911334,
            174683223,
            174683223,
            665914410,
            665914410,
            289023634,
            289023634,
            745952050,
            745952050,
            705843235,
            705843235,
            660383525,
            660383525,
            762199600,
            762199600,
            588240922,
            588240922,
            640458823,
            640458823,
            688341046,
            688341046,
            759127272,
            759127272,
            587856300,
            587856300,
            763169902,
            763169902,
            753963037,
            753963037,
            385845335,
            385845335,
            739551437,
            739551437,
            760405978,
            760405978,
            685352476,
            685352476,
            696561872,
            696561872,
            657262979,
            657262979,
            720021702,
            720021702,
            467100222,
            467100222,
            559776287,
            559776287,
            730408061,
            730408061,
            451309280,
            451309280,
            357130175,
            357130175,
            733518272,
            733518272,
            746834150,
            746834150,
            740911794,
            740911794,
            295199620,
            295199620,
            335961367,
            335961367,
            742859242,
            742859242,
            727549513,
            727549513,
            733518278,
            733518278,
            366801389,
            366801389,
            682834518,
            682834518,
            683069582,
            683069582,
            748526168,
            748526168,
            755158934,
            755158934,
            697682028,
            697682028,
            745471986,
            745471986,
            276917768,
            276917768,
            666669564,
            666669564,
            731312766,
            731312766,
            723125368,
            723125368,
            717172643,
            717172643,
            760147922,
            760147922,
            717244814,
            717244814,
            660295336,
            660295336,
            683644441,
            683644441,
            705827219,
            705827219,
            755639025,
            755639025,
            496625326,
            496625326,
            695990023,
            695990023,
            606448807,
            606448807,
            715810876,
            715810876,
            374155874,
            374155874,
            646573661,
            646573661,
            716788027,
            716788027,
            651994508,
            651994508,
            748980632,
            748980632,
            758765271,
            758765271,
            356353699,
            356353699,
            758765274,
            758765274,
            678809283,
            678809283,
            759911993,
            759911993,
            18665353,
            18665353,
            608934996,
            608934996,
            713076101,
            713076101,
            363521331,
            363521331,
            715032747,
            715032747,
            552664323,
            552664323,
            707541832,
            707541832,
            728934301,
            728934301,
            718126912,
            718126912,
            744524408,
            744524408,
            747386021,
            747386021,
            758059311,
            758059311,
            755903660,
            755903660,
            689903611,
            689903611,
            757441852,
            757441852,
            759133862,
            759133862,
            753466940,
            753466940,
            758405591,
            758405591,
            733796334,
            733796334,
            677149069,
            677149069,
            695729380,
            695729380,
            638978513,
            638978513,
            751944794,
            751944794,
            639356576,
            639356576,
            390955989,
            390955989,
            746779395,
            746779395,
            600228406,
            600228406,
            558227001,
            558227001,
            705065137,
            705065137,
            354540069,
            354540069,
            731816811,
            731816811,
            404005996,
            404005996,
            758650213,
            758650213,
            741535842,
            741535842,
            296312943,
            296312943,
            747628061,
            747628061,
            713197752,
            713197752,
            564579403,
            564579403,
            585820682,
            585820682,
            750268538,
            750268538,
            756367317,
            756367317,
            718208579,
            718208579,
            427986272,
            427986272,
            727637754,
            727637754,
            744485673,
            744485673,
            628931883,
            628931883,
            456892258,
            456892258,
            756471569,
            756471569,
            598960148,
            598960148,
            713799473,
            713799473,
            417178887,
            417178887,
            737186928,
            737186928,
            94521547,
            94521547,
            502162600,
            502162600,
            572141141,
            572141141,
            739568867,
            739568867,
            326192500,
            326192500,
            709200435,
            709200435,
            704409042,
            704409042,
            688894587,
            688894587,
            759012241,
            759012241,
            720535256,
            720535256,
            728780500,
            728780500,
            656917140,
            656917140,
            757425830,
            757425830,
            645139454,
            645139454,
            746840750,
            746840750,
            123558863,
            123558863,
            305467369,
            305467369,
            392974270,
            392974270,
            693850147,
            693850147,
            475648704,
            475648704,
            690413679,
            690413679,
            741199059,
            741199059,
            376936273,
            376936273,
            491944772,
            491944772,
            751774952,
            751774952,
            757425836,
            757425836,
            254953469,
            254953469,
            758075375,
            758075375,
            763185991,
            763185991,
            734782698,
            734782698,
            710126303,
            710126303,
            702131361,
            702131361,
            656884967,
            656884967,
            743106232,
            743106232,
            700511528,
            700511528,
            744010923,
            744010923,
            716915011,
            716915011,
            722802127,
            722802127,
            693160225,
            693160225,
            740029456,
            740029456,
            725183660,
            725183660,
            530893821,
            530893821,
            737411586,
            737411586,
            590064972,
            590064972,
            731656456,
            731656456,
            391546609,
            391546609,
            722907728,
            722907728,
            282458645,
            282458645,
            737827406,
            737827406,
            594609525,
            594609525,
            375540689,
            375540689,
            752048779,
            752048779,
            718656496,
            718656496,
            121071342,
            121071342,
            695719936,
            695719936,
            105553415,
            105553415,
            515200466,
            515200466,
            561700428,
            561700428,
            713180391,
            713180391,
            686015307,
            686015307,
            694202707,
            694202707,
            625557070,
            625557070,
            737810029,
            737810029,
            693850160,
            693850160,
            721777052,
            721777052,
            468430274,
            468430274,
            763070935,
            763070935,
            546247706,
            546247706,
            722747356,
            722747356,
            683474632,
            683474632,
            544901976,
            544901976,
            721296973,
            721296973,
            749598140,
            749598140,
            741535879,
            741535879,
            329888416,
            329888416,
            740002602,
            740002602,
            388939573,
            388939573,
            211204915,
            211204915,
            583799818,
            583799818,
            403352515,
            403352515,
            236357130,
            236357130,
            400347904,
            400347904,
            543081372,
            543081372,
            431299023,
            431299023,
            726706232,
            726706232,
            377111078,
            377111078,
            281216880,
            281216880,
            721783621,
            721783621,
            646890500,
            646890500,
            714206838,
            714206838,
            674980005,
            674980005,
            753793250,
            753793250,
            723475635,
            723475635,
            281488362,
            281488362,
            684356731,
            684356731,
            731496094,
            731496094,
            512709379,
            512709379,
            426646844,
            426646844,
            713844819,
            713844819,
            409654584,
            409654584,
            754923934,
            754923934,
            713197792,
            713197792,
            688691333,
            688691333,
            591378944,
            591378944,
            399507278,
            399507278,
            691573839,
            691573839,
            749928395,
            749928395,
            710486020,
            710486020,
            318822022,
            318822022,
            703101692,
            703101692,
            372172431,
            372172431,
            755524011,
            755524011,
            211060588,
            211060588,
            741502464,
            741502464,
            742230736,
            742230736,
            733835131,
            733835131,
            710734617,
            710734617,
            626445740,
            626445740,
            751565144,
            751565144,
            750909045,
            750909045,
            703373178,
            703373178,
            725095480,
            725095480,
            482087704,
            482087704,
            580760446,
            580760446,
            754315664,
            754315664,
            558763161,
            558763161,
            759532353,
            759532353,
            724373773,
            724373773,
            719937043,
            719937043,
            648128069,
            648128069,
            690757361,
            690757361,
            716098167,
            716098167,
            702148788,
            702148788,
            749172862,
            749172862,
            749238472,
            749238472,
            754907905,
            754907905,
            551782298,
            551782298,
            753947084,
            753947084,
            157747188,
            157747188,
            655296942,
            655296942,
            617896327,
            617896327,
            733956777,
            733956777,
            203017537,
            203017537,
            472001087,
            472001087,
            469865887,
            469865887,
            702027156,
            702027156,
            733145214,
            733145214,
            716071305,
            716071305,
            720525820,
            720525820,
            403522393,
            403522393,
            346255035,
            346255035,
            53299489,
            53299489,
            701096840,
            701096840,
            396161612,
            396161612,
            707420267,
            707420267,
            712530882,
            712530882,
            558227062,
            558227062,
            728090624,
            728090624,
            355684214,
            355684214,
            423968512,
            423968512,
        );

        foreach ($Redis->hKeys(SearchPreferences::REDIS_HASH_USERS_SEARCH_PREFERENCES_KEY) as $userId) {
            if (in_array($userId, $blackList)) {
                continue;
            }

            $this->getBatteryObject()->set((int) $userId, 5);

            try {
                $this->log(var_export($Mamba->Notify()->sendMessage((int) $userId, self::SECOND_NEWSLETTER_MESSAGE), true));
                $this->log(var_export($Mamba->Notify()->sendMessage((int) $userId, self::FIRST_NEWSLETTER_MESSAGE), true));
            } catch (\Exception $e) {
                sleep(60);
            }
        }
    }
}